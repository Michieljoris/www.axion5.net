<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> 
<html class="no-js" xmlns:ng="http://angularjs.org" lang="en">
  <!--<![endif]-->
  <head id="head"><title>Blog-Meteor, docs and attached files</title><meta charset='utf-8'/><meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'/><meta content='' name='description'/><meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1'/>
<!--partial:html/ieshim.html--><!--[if lte IE 8]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <script>
      // The ieshiv takes care of our ui.directives, bootstrap module directives and 
      // AngularJS's ng-view, ng-include, ng-pluralize and ng-switch directives.
      // However, IF you have custom directives (yours or someone else's) then
      // enumerate the list of tags in window.myCustomTags

      window.myCustomTags = [ 'yourDirective', 'somebodyElsesDirective' ]; // optional
    </script>
    <script src="js/angular-ui-ieshiv.js"></script>
    <![endif]-->						    

<script type="text/javascript" src="/denodify.js"></script>

<link rel="stylesheet" type="text/css" href="/css/bower/normalize.css/normalize.css">
<link rel="stylesheet" type="text/css" href="/css/bower/bootstrap/dist/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="/css/tweak.css">
<link rel="stylesheet" type="text/css" href="/css/prettify.css">
<link rel="stylesheet" type="text/css" href="/css/medium-editor.css">
<link rel="stylesheet" type="text/css" href="/css/medium-default-theme.css">
<link rel="stylesheet" type="text/css" href="/css/blog.css">
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="stylesheet" type="text/css" href="/css/main-edit.css">

<script type='text/javascript'>function cachify(path) { return path; }</script></head>
  <body id="body" onload="prettyPrint()"><!--partial:html/body-blog.html--><!--[if lt IE 7]>
    <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

<!-- <div class="row"> -->
<div id="editbar--" > </div>
<!-- </div> -->


<div class="blog-masthead">
  <div class="container">
    <nav class="blog-nav">
      <a class="blog-nav-item active" href="/">Home</a>
      <a class="blog-nav-item" href="/projects.html">Projects</a>
      <a class="blog-nav-item" href="/websites.html">Websites</a>
      <a class="blog-nav-item" href="/aboutme.html">About me</a>
      <a id="site-title" href="/">Axion5</a>
    </nav>
  </div>
</div>

<div id="main" class="container">

  <div class="blog-header">
    <h1 class="blog-title">Axion5</h1>
    <p class="lead blog-description">The official example template of creating a blog with Bootstrap.</p>
  </div>

  <div id="blog-body" class="row">

    <div class="col-sm-8 blog-main">

      <div id="pageTitle--"><header >
  <h1 class="title blog-post-title">  Meteor, docs and attached files  </h1>
  <time class="blog-post-meta" datetime="21st of October 2014">  21st of October 2014  </time>
</header></div>
      <div  id="main--" class="blog-post"><!--partial:post/meteor-docs-and-attached-files.org--><pre>comments: false
published: true
title: Meteor, docs and attached files</pre>
<p>You can store files directly in MongoDB documents, however there is a limit of
16MB and the Meteor DDP protocol might not be up to the task (reference..)</p>
<p>There are two atmosphere packages that attempt to fill the gap:</p>
<ol><li>CollectionFS</li>
<li>fileCollection</li>
</ol>
<p>Both are extensively documentend, with the latter one being the lighter one.
They either use the MongoDB GridFS or store files externally on S3 or the
server’s file system. They both tie in with the MongoDB style of organising
data, extending functionality of collections, by having special ‘file’
collections.  These ‘file’ documents can then be referenced from other
documents. With these packages come API’s and systems for security,
manipulation, filtering, UI helpers etc.  My eyes drooped and my mind wandered
every time I tried to read through the documentation for these packages. It
seemed a bit overdone, at least for my purposes.  I have used CouchDB somewhat,
and files are called attachments in that corner of the database world. The API
is simple, just ‘attach’ them, and CouchDB takes care of storing them. Access
rights are tied to the document they are attached to.  I tried to implement
something similar for Meteor.  Instead of storing the files in MongoDB, they are
stored on and read from the server’s hard disk through a separate static file
server. Files are attached by path and name to a document, as an array of file
objects. Each object can contain as much meta data as you like, but at least the
path and name.  To access a file from the file server an access key needs to
accompany the request for the file. This access key is generated (and encrypted)
server side by Meteor when the document is published that has the reference to
the file. The access key contains two references, one to the currently logged in
user’s hashed log in token, and one to md5 hash of the contents of the file.
Because transform (reference..) doesn’t work on the server side I am using added
and friends to modify the relevant docs when published: Draft of attaching
access keys to files in Meteor.publish</p>
<pre class="prettyprint"><code class="language-javascript">module.exports = function(req) {
    if (req.url.pathname.indexOf(&#39;/public&#39;) === 0) return VOW.kept(); 
    var vow = VOW.make();
    
    var query = req.url.search;
    var decrypted = decrypt(query.slice(1), pwd);
    var data;
    if (decrypted.error) 
        vow.break({ forbidden: true, srcPath: req.url.pathname });
    else {
        try {
            data = JSON.parse(decrypted.decrypted);
        } catch(e) {
            vow.break({ forbidden: true, srcPath: req.url.pathname });
        }
        var hashedToken = data.l;
        retrieveUser(hashedToken).when(
            function(user) {
                console.log(&#34;file retrieval of &#34; + req.url.pathname  + &#39; by &#39; , user.emails);
                vow.keep();
                
            },
            function(err) {
                console.log(err);
                vow.break({ forbidden: true, srcPath: req.url.pathname });
            }
        );
    }
    return vow.promise;
  
};</code>
</pre>
<p>Requests come in the form of:</p>
<p><a href="http://files.server.com/path/to/somefile?KJSDFS93450FJDKSFJKDJFLSFS8908">http://files.server.com/path/to/somefile?KJSDFS93450FJDKSFJKDJFLSFS8908</a></p>
<p>With the part after the question mark being the access key.</p>
<p>When a user uploads a file, the md5 of the file can be calculated client side
(by a library such as SparkMD5 for instance), and saved with the document. You
could then forbid updating the md5 of any attachments server side perhaps, or
attach them server side when the documents gets saved.</p>
<p>Users could reuse an access key for a different path on the file server, in the
same session (with the same login token) only if the file on that different path
has the same md5 checksum, in other words, it’s the same file.</p>
<p>Additional access rights to documents and thus to files can be granted to users
within the same session, however when you take away access rights the documents
will be ‘denied’, but the files will still be accessible. However when the
logged in user logs out and then in again (new loginToken) the files will be
disallowed as well. You could perhaps force to log everybody out
Meteor.logoutOtherClients, or somehow issue everybody with new login tokens.</p>
<p>Another caveat is that once a user copies or retrieves the url to a file, this
url will work in any browser, on any computer as long as the user is logged
in. It might be possible to work around this by setting a cookie (to the
loginToken for example) in the tab and browser where the user is logged into the
app. The file server can check whether the loginToken in the decrypted access
key is the same as the cookie received with the request.</p>
<p>The system is rather simple, and only needs a slight modification to an
otherwise open static file server (I used my own bb-server), and a small
adaption of publish functions for documents that can refer to files. You also
have to write the user interface part of listing, uploading, deleting,
retrieving of file attachments.</p>
<p>For my own and future reference here is the code for uploading files:</p>
<p>Custom styleable upload link</p>
<pre class="prettyprint"><code class="language-html">&#60;input type=&#34;file&#34; id=&#34;fileElem&#34; multiple accept=&#34;*&#34; style=&#34;display:none&#34; onchange=&#34;handleFiles(this.files)&#34;&#62;
&#60;a href=&#34;#&#34; id=&#34;fileSelect&#34;&#62;Select files&#60;/a&#62;</code>
</pre>
<p>Use HTML5 filereader to read and ajax post the file</p>
<pre class="prettyprint"><code class="language-javascript">function saveFile(fileName, data) {
    if (!fileName) {
        console.log(&#39;no filename, so not saving&#39;, data);
    }
    console.log(&#39;Saving file &#39; + fileName);
    HTTP.call(&#39;POST&#39;, FILEHOST + &#39;/?path=&#39; + fileName, {
        content: data
    }, function(error, result) {
        console.log(&#39;error: &#39;, error, &#39;\nresult: &#39;, result);
	if (error) {
            console.log(&#39;Failed to save on the server &#39;, data.error);
            alert(&#39;Warning: this file did not save to the server!!&#39;);
	}
	else console.log(&#34;Success. Data saved to:&#34;, fileName);
    });
} 

handleFiles = function handleFiles(files) {
    // console.log(files);
    var fileList = files; /* now you can work with the file list */
    var reader = new FileReader();
    reader.onload = function(data) {
        //post to bb-server 
	//TODO calculate MD5 of every file
	//TODO add multiple file upload support
        saveFile(fileList[0].name, reader.result);
    };
    // console.log(fileList[0]);
    reader.readAsText(fileList[0]);
};
server, database, Meteor</code>
</pre>
</div>
      <div  id="page--" class="page"> </div>
      <div  id="disqus-embed--"> </div>
      <div  id="disqus-count--"> </div>

    </div><!-- /.blog-main -->

    <div id="rightbar--" class="box col-sm-3 col-sm-offset-1 blog-sidebar"><!--partial:html/search.html--><div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:www.axion5.net">
  </form>
</div>
<!--partial:html/aboutmeWidget.html--><div class="widget sidebar-module sidebar-module-inset">
  <b>About me</b></br> I put this site together as a place to showcase the
  various websites and projects I've done, and to perhaps publish what I think
  might be useful for others to read.  If you are interested in contracting me
  to build a website for you, please head over to websites where I've listed the
  sites I've done so far and a little info on how it was done.  On the projects
  page I've listed a few of my more elaborate or interesting software projects
  I've done so far. The source code for these and others is up on github.  If
  you're interested in me personally please check out the about page. For more
  detailed background on me please checkout either linkedin or
  careers.stackoverflow.  Contact me at mail@axion5.net
</div>
<!--partial:html/recentWidgetWrapper.html--><div class="widget sidebar-module">
  <b>Recent posts</b>
  <div id="widget--"><ul id="most-recent-partial">
  <li><a href="/post/post2.html">post2</a></li>
  <li><a href="/post/markup-cheat-sheet-for-org-mode.html">Markup Cheat sheet for Org-mode</a></li>
  <li><a href="/post/meteor-docs-and-attached-files.html">Meteor, docs and attached files</a></li>
</ul></div>
</div>
<!--partial:html/tagWidgetWrapper.html--><div class="widget sidebar-module ">
  <b>Tags</b>
  <div id="widget--"><ul id="by-tag-partial">

</ul></div>
</div>
<!--partial:html/archiveWidgetWrapper.html--><div class="widget sidebar-module">
  <b>Archive</b>
  <div id="widget--"><ul class="css-treeview" id="archive-partial">
 <li><a  href="/archive/2014" >2014</a>
  <ul>
   <li><a  href="/archive/2014/October" >October</a>
    <ul>
     <li><a  href="/post/post2.html" >post2</a></li>
     <li><a  href="/post/markup-cheat-sheet-for-org-mode.html" >Markup Cheat sheet for Org-mode</a></li>
     <li><a  href="/post/meteor-docs-and-attached-files.html" >Meteor, docs and attached files</a></li>
    </ul>
   </li>
  </ul>
 </li>
</ul></div>
</div>
</div><!-- /.blog-sidebar -->

  </div><!-- /.row -->

</div><!-- /.container -->

<div class="blog-footer">
  <p>Site rendered from org files using 
<a href="http://github.com/michieljoris/bb-blog">bb-blog</a> and
    <a href="http://github.com/michieljoris/html-builder">html-builder</a>
    by <a href="https://github.com/michieljoris">@michieljoris</a>.</p>
  <p>
    <a href="#">Back to top</a>
  </p>
</div>

<script type="text/javascript" src="/scripts/bower/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="/scripts/bower/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript" src="/scripts/bower/modernizr/modernizr.js"></script>
<script type="text/javascript" src="/scripts/bower/bacon/dist/Bacon.min.js"></script>
<script type="text/javascript" src="/scripts/bower/logthis/logthis.js"></script>
<script type="text/javascript" src="/scripts/medium-editor.js"></script>
<script type="text/javascript" src="/scripts/prettify.js"></script>
<script type="text/javascript" src="/scripts/main.js?module=0"></script>
<script type="text/javascript" src="/scripts/start.js"></script>
</body>
</html>	
	 
