<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" xmlns:ng="http://angularjs.org" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> 
<html class="no-js" xmlns:ng="http://angularjs.org" lang="en">
  <!--<![endif]-->
  <head id="head"><title>Axion5-Adea, an experiment in app back end infrastructure</title><meta charset='utf-8'/><meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'/><meta content='' name='description'/><meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1'/>
<!--partial:html/ieshim.html--><!--[if lte IE 8]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <script>
      // The ieshiv takes care of our ui.directives, bootstrap module directives and 
      // AngularJS's ng-view, ng-include, ng-pluralize and ng-switch directives.
      // However, IF you have custom directives (yours or someone else's) then
      // enumerate the list of tags in window.myCustomTags

      window.myCustomTags = [ 'yourDirective', 'somebodyElsesDirective' ]; // optional
    </script>
    <script src="js/angular-ui-ieshiv.js"></script>
    <![endif]-->						    


<link rel="stylesheet" type="text/css" href="/css/bower/normalize.css/normalize.css">
<link rel="stylesheet" type="text/css" href="/css/bower/bootstrap/dist/css/bootstrap.css">
<link rel="stylesheet" type="text/css" href="/css/tweak.css">
<link rel="stylesheet" type="text/css" href="/css/highlightjs/hybrid.css">
<link rel="stylesheet" type="text/css" href="/css/blog.css">
<link rel="stylesheet" type="text/css" href="/css/main.css">

<script type='text/javascript'>function cachify(path) { return path; }</script><!--partial:html/google_analytics.html--><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27130001-2', 'auto');
  ga('send', 'pageview');

</script>
</head>
  <body id="body" ><!--partial:html/body-blog.html--><!--[if lt IE 7]>
    <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
    <![endif]-->

<!-- <div class="row"> -->
<div id="editbar--" > </div>
<!-- </div> -->


<div class="blog-masthead">
  <div class="container">
    <nav class="blog-nav">
      <a id="menu-blog" class="blog-nav-item" href="/">Blog</a>
      <a id="menu-projects" class="blog-nav-item" href="/projects.html">Projects</a>
      <a id="menu-websites" class="blog-nav-item" href="/websites.html">Websites</a>
      <a id="menu-aboutme" class="blog-nav-item" href="/aboutme.html">About me</a>
      <a id="site-title" href="/">Axion5</a>
    </nav>
  </div>
</div>

<div id="main" class="container">

  <div class="blog-header">
    <h1 class="blog-title">Axion5</h1>
    <p class="lead blog-description">The official example template of creating a blog with Bootstrap.</p>
  </div>

  <div align="justify" id="blog-body" class="row">

    <div class="col-sm-9 blog-main">

      <div class="pageTitle" id="pageTitle--"><header >
  <div class="title blog-post-title">  Adea, an experiment in app back end infrastructure  </div>
  <time class="blog-post-meta" datetime="24th of December 2014">  24th of December 2014  </time>
</header></div>
      <div  id="main--" class="blog-post"><!--partial:post/adea-experimental-app-deployment.org--><div id="toc"><ul></ul>
</div><pre>comments: true
published: true
title: Adea, an experiment in app back end infrastructure
tags: web internet rethink </pre>
<p>As per the last <a href="http://www.axion5.net/post/the-web-is-not-a-good-fit-really.html">blog post</a> I want to describe a system and infrastructure to
serve as the back end for a (web) app. I want to challenge some commonly held
ideas of how to organise such a thing. Since the legacy of a document based web
architecture has left us with a server-client paradigm and therefore a
functional application (the &#39;server&#39;) on the server side (as it has left us with
endless dom meddling on the client side) we&#39;re going reevalute the use and
function of this server application. To do this properly we&#39;re going to try to
make do without it all together. Removing the server from the server-client
schism is one sure fire way to remove the schism and therefore break the old
paradigm. Some interesting things might follow from this.</p>
<pre>--------------------------------</pre>
<p>Since this is an experiment I am setting some further limitations, the first one
is technologies used. Some are relatively novel, but they are also few in number, namely:</p>
<ol><li>dockerFor ready made instances of the following three.</li>
<li>serfTo coordinate servers in a multi-server setup</li>
<li>A proxy serverTo control access to a particular server and/or databases</li>
<li>couchdbData has to be stored somewhere..</li>
</ol>
<h3 id="header-0-1"><span class="section-number">0.1</span>Requirements:</h3>
<p>The following is a list of requirements for the setup. Some are essential, some
can be compromised on. But all try to make use of the technologies as best as possible.</p>
<h4 id="header-0-1-1"><span class="section-number">0.1.1</span>Apps talk directly to a database at all times</h4>
This leverages the http end point feature of couchdb. Couchdb has also a solidauthentication and authorization system built-in and has no problem with dealingwith a lot of connections at the same time (Erlang based). Further more it isgood at replicating databases between instances and is able to provide a changesfeed, thus enabling apps to directly respond to changes in a database.<h4 id="header-0-1-2"><span class="section-number">0.1.2</span>A solid read and write permmission and role system needs to implemented </h4>
This is a problem for couchdb since it is not very good at read validation, andonly checks access at a database level. The usual solution is to separate thedata into multiple databases based on read permissions. But we still want thedata to replicate between instances.<h4 id="header-0-1-3"><span class="section-number">0.1.3</span>All data is contained in one database which is replicated between pods.</h4>
This is pull and push replication. Also data from the aggregate gets replicated oneway only into partitioned databases. <h4 id="header-0-1-4"><span class="section-number">0.1.4</span>Users can never access the main aggregate.</h4>
Instead they access duplicates of this data from partitioned by accessdatabases.<h4 id="header-0-1-5"><span class="section-number">0.1.5</span>Every document in the aggregate might be duplicated in one of the partitioned databases</h4>
But only once. No two partitioned databases may contain the same document (byid).<h4 id="header-0-1-6"><span class="section-number">0.1.6</span>In a pod ring every pod maintains its own pod status document</h4>
Which gets replicated to all other pods. In this document is data such as podid, couchdb stats, vps stats and last deleted doc in the partitioned databases.Nobody else writes to this document but the pod itself.<h4 id="header-0-1-7"><span class="section-number">0.1.7</span>No dns, or at least no hard dependency.</h4>
A user needs to find the app, so an url for that will be needed, and a dnslookup. One could use a central place where pods or pod rings register ipaddresses. Once an app is loaded (from a pod&#39;s database for instance) one couldimagine that the app questions the pod on other ip addresses of other pods inthe ring. Or again looks in a central registry where pods register their ipaddresses. Pods might also be able to configure their own dns settings. An apponly needs access to one pod, somehow, to be able to access the others.<h4 id="header-0-1-8"><span class="section-number">0.1.8</span>No load balancing, instead clients find their own most efficient server</h4>
Once an app knows the ip addresses of al the pods in a ring, it can be made theapps responsibility to choose the pod with the most capacity in terms ofconnections or latency or other parameters it either can measure itself, or thatare being reported by the separate pods. Remember, all pods know all about allother pods in a pod ring.<h4 id="header-0-1-9"><span class="section-number">0.1.9</span>Every machine or vps is completely autonomous</h4>
Meaning it can take action without being told so by a master vps, and no vps ismore important than another. It can manage its own affairs and no decision oraction it takes should endanger the cluster. No vps is dependent on another vps.All knowledge of the cluster is shared. Etc, you get the idea. <h4 id="header-0-1-10"><span class="section-number">0.1.10</span>A cluster, or pod ring is self adjusting, depending on load.</h4>
<h4 id="header-0-1-11"><span class="section-number">0.1.11</span>A pod ring should be robust and be able to cope with all but one pod failing</h4>
Using a watts-newman small world network between pods all pods should keepreplicating to each other and stay in sync at all times. The watts-newmannetwork model can be implemented by every single pod independently withoutconsulting or taking into account what other pods decide to connect to. It alsopredicts relatively low average hop count even when there are dozens and dozensor possibly hundreds of pods in a pod ring. When a pod disappears from a podring it will self adjust, as it will when a pod is added (again). For this towork every pod needs a working serf instance that has been hooked up to the podsserf network, as the pod knows about the network through serf.<p>Clients will also always notice a pod failing and should redirect requests to another pod
in the ring if the app is designed properly.</p>
<h4 id="header-0-1-12"><span class="section-number">0.1.12</span>A user can start a new pod ring with just the data accessible in another pod ring</h4>
So users own their data. They can replicate their own data to a pod they controland then delete the data in the old pod (ring). When the data is shared withother users, they will also not be able to use the old pod (ring) to access thedata.<h4 id="header-0-1-13"><span class="section-number">0.1.13</span>Apps should leverage couchdb&#39;s replication and changes feed features</h4>
With a bit effort separate users of the same app and connecting to the same pod(ring) should be easy to sync up with each other using these couchdb feautures.The ultimate goal is to achieve parity with most features in meteorjs.<h4 id="header-0-1-14"><span class="section-number">0.1.14</span>Every pod has minimal workers behind its database</h4>
These workers are doing registration, send emails, do maintenance on thedatabases, monitor and report the pods state etc, but should contain minimal appor business logic. This should reside in the apps/client themselves. It is thequestion in how far you can go with this. <h4 id="header-0-1-15"><span class="section-number">0.1.15</span>The whole system is message based</h4>
From pod to pod and from pod to app. This maximizes decoupling. No app or podshould be reliant on a specific response or for that matter any response to amessage sent. If a message is confirmed, or other wise is returning data the appmay use this, but it can not expect or wait for this. It should be able to makedo and not fail or otherwise &#39;crash&#39;, but should always present a reasable ui tothe user and do its best to resolve the situation. Data should always beretrieved by direct database access. <h4 id="header-0-1-16"><span class="section-number">0.1.16</span>No possibility of creating document conflicts</h4>
A logical consequence of having only one writable pod.<h4 id="header-0-1-17"><span class="section-number">0.1.17</span>A proxy is used for basic access control.</h4>
For maintenance it might be useful to cut of access to a couchdb instance, orcertain databases can be made write-only by disallowing get requests on thedatabase. This proxy can also do basic reporting and logging of connections andrequests.<h3 id="header-0-2"><span class="section-number">0.2</span>Compromises/trade-offs</h3>
<h4 id="header-0-2-1"><span class="section-number">0.2.1</span>Easily scalable for read operations, but not for write operations</h4>
An app can use any pod to read from, but only one to write to, and that pod isthe same for all clients. This is not only to prevent document conflicts, butalso to enable proper implementation of a access system based on permissions androles.<h4 id="header-0-2-2"><span class="section-number">0.2.2</span>No sharding of data</h4>
But one can use bigcouch, cloudant or couchdb 2.0 for this if needed. Every podhas a complete copy of all the data. So this system favors connection heavy, cpuheavy applications, since we can keep firing up new pods to deal with additionalload. But a vps has a limit on how data it can store (hard disk limit), plus allthis will have to be replicated to every new pod on creation. This becomestroublesome once we&#39;re talking about gigabytes of data. One solution would be tostore big files such as images and video and sound files outside the pod ringand in a key value store somewhere. But that would need a server in front of itto enforce permissions.<h4 id="header-0-2-3"><span class="section-number">0.2.3</span>Every node uses duplication of data to control read access.</h4>
Even when couchdb implements &#34;validate doc read&#34; this will be necessary becauseviews are recalculated into indexed and will not the &#34;vdr&#34; function to validateread access. Every pod therefore will have to duplicate its data to some degree.If all data is accessed in a pod by users it will have a duplication ration ofat least two. If the pod is nice enough to then aggregate this again to somedegree or other for individual users the duplication ration might be much higherthan two. On the other hand every pod only needs to leave in one piece the mainaggregate that&#39;s replicated between pods. All other databases it can destroy andcreate at its own discretion, taking matters such as load and space intoconsideration. This will mess with users who are reading from these databases,or have change feeds set up of course. <h3 id="header-0-3"><span class="section-number">0.3</span>Implementation</h3>
</div>
      <div  id="page--" class="page"> </div>
      <div  id="disqus-embed--"><!--partial:html/disqus-embed.html--><div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'axion52'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>
      <div  id="disqus-count--"><!--partial:html/disqus-count.html--><script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'axion52'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
  var s = document.createElement('script'); s.async = true;
  s.type = 'text/javascript';
  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
</div>

    </div><!-- /.blog-main -->

    <div id="rightbar--" class="box col-sm-3 col-sm-offset-1 blog-sidebar"><!--partial:html/search.html--><div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:www.axion5.net">
  </form>
</div>
<!--partial:html/aboutmeWidgetWrapper.html--><div align="justify" class="widget sidebar-module sidebar-module-inset">
  <div id="widget--"><!--partial:widgets/aboutmeWidget.org--><div id="toc"><ul></ul>
</div><h5 id="header-0-0-0-1"><span class="section-number">0.0.0.1</span>About me </h5>
<p>Dutch by birth, living in Australia since late youth, classical pianist, but 
closet programmer since childhood. This site hopefully is able to showcase some 
of my more useful fabrications and thoughts.</p>
<p>All my code is on <a href="http://github.com/michieljoris">github</a>. </p>
<p>For more info see the <a href="/aboutme.html">about me</a> page, <a href="http://au.linkedin.com/in/michieljoris/">linkedin</a> or 
<a href="http://careers.stackoverflow.com/michieljoris">stackoverflow</a>.</p>
<p>Email me at <a href="mailto:mail@axion5.net">mail@axion5.net</a></p>
</div>
</div>

<!--partial:html/recentWidgetWrapper.html--><div class="widget sidebar-module">
  <b>Recent posts</b>
  <div id="widget--"><ul id="most-recent-partial">
  <li><a href="/post/the-web-is-not-a-good-fit-really.html">The web is not a good fit really..</a></li>
  <li><a href="/post/my-webstack.html">My webstack</a></li>
  <li><a href="/post/meteor-docs-and-attached-files.html">Meteor, docs and attached files</a></li>
  <li><a href="/post/about-this-site.html">About this site</a></li>
  <li><a href="/post/markup-cheat-sheet-for-org-mode.html">Markup Cheat sheet for Org-mode</a></li>
</ul></div>
</div>
<!--partial:html/tagWidgetWrapper.html--><div class="widget sidebar-module ">
  <b>Tags</b>
  <div id="widget--"><ul id="by-tag-partial">
  <li><a href="/tag/web">web</a> (2)</li>
  <li><a href="/tag/rethink">rethink</a> (2)</li>
  <li><a href="/tag/internet">internet</a> (2)</li>
  <li><a href="/tag/Emacs">Emacs</a> (1)</li>
  <li><a href="/tag/Clojure">Clojure</a> (1)</li>
</ul></div>
</div>
<!--partial:html/archiveWidgetWrapper.html--><div class="widget sidebar-module">
  <b>Archive</b>
  <div id="widget--"><ul class="css-treeview" id="archive-partial">
 <li><a  href="/archive/2014" >2014</a>
  <ul>
   <li><a  href="/archive/2014/April" >April</a>
    <ul>
     <li><a  href="/post/my-webstack.html" >My webstack</a></li>
    </ul>
   </li>
   <li><a  href="/archive/2014/June" >June</a>
    <ul>
     <li><a  href="/post/meteor-docs-and-attached-files.html" >Meteor, docs and attached files</a></li>
    </ul>
   </li>
   <li><a  href="/archive/2014/October" >October</a>
    <ul>
     <li><a  href="/post/markup-cheat-sheet-for-org-mode.html" >Markup Cheat sheet for Org-mode</a></li>
     <li><a  href="/post/about-this-site.html" >About this site</a></li>
    </ul>
   </li>
   <li><a  href="/archive/2014/November" >November</a>
    <ul>
     <li><a  href="/post/installing-and-using-clojure-and-clojurescript-with-emacs.html" >Installing and using Clojure and ClojureScript with Emacs</a></li>
    </ul>
   </li>
   <li><a  href="/archive/2014/December" >December</a>
    <ul>
     <li><a  href="/post/the-web-is-not-a-good-fit-really.html" >The web is not a good fit really..</a></li>
     <li><a  href="/post/adea-an-experiment-in-app-back-end-infrastructure.html" >Adea, an experiment in app back end infrastructure</a></li>
    </ul>
   </li>
  </ul>
 </li>
</ul></div>
</div>
</div><!-- /.blog-sidebar -->

  </div><!-- /.row -->

</div><!-- /.container -->

<div class="blog-footer">
  <p>Site rendered from org files using 
<a href="http://github.com/michieljoris/bb-blog">bb-blog</a> and
    <a href="http://github.com/michieljoris/html-builder">html-builder</a>
    by <a href="https://github.com/michieljoris">@michieljoris</a>.</p>
  <p>
    <a href="#">Back to top</a>
  </p>
</div>

<script type="text/javascript" src="/scripts/bower/jquery/dist/jquery.js"></script>
<script type="text/javascript" src="/scripts/bower/bootstrap/dist/js/bootstrap.js"></script>
<script type="text/javascript" src="/scripts/bower/modernizr/modernizr.js"></script>
<script type="text/javascript" src="/scripts/bower/logthis/logthis.js"></script>
<script type="text/javascript" src="/scripts/highlight.pack.js"></script>
<script type="text/javascript" src="/scripts/main.js"></script>
<script>hljs.initHighlightingOnLoad();</script></body>
</html>	
	 
